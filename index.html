<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geo-Spatial Street Scanner</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 0; }
        
        .scroller::-webkit-scrollbar { width: 6px; }
        .scroller::-webkit-scrollbar-track { background: #f1f1f1; }
        .scroller::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        .drawing-cursor { cursor: crosshair !important; }

        /* Enhanced Start Node */
        .pulse-icon {
            background: #ef4444;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            animation: pulse-red 1.5s infinite;
            cursor: pointer !important;
        }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.3); box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen bg-gray-100 font-sans">

    <!-- Sidebar Panel -->
    <div class="w-full md:w-96 bg-white shadow-xl z-10 flex flex-col h-1/3 md:h-full transition-all duration-300 relative border-r border-gray-200">
        
        <div class="p-6 bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-md">
            <h1 class="text-xl font-bold flex items-center gap-2">
                <i class="fa-solid fa-draw-polygon"></i> Area Scanner
            </h1>
            <p class="text-xs text-blue-100 mt-1 opacity-90">Find all streets inside your custom shape.</p>
        </div>

        <div class="p-4 border-b border-gray-100 bg-gray-50 flex flex-col gap-2">
            <div class="flex gap-2">
                <button id="drawBtn" class="flex-1 bg-white border border-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-blue-50 hover:border-blue-300 transition-all flex items-center justify-center gap-2 shadow-sm">
                    <i class="fa-solid fa-pen-nib"></i> <span id="drawBtnText">Start Drawing</span>
                </button>
                <button id="resetBtn" class="bg-white border border-gray-300 text-gray-500 px-3 py-2 rounded-lg hover:text-red-500 hover:border-red-200 transition-all shadow-sm" title="Clear Map">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            <button id="finishBtn" class="hidden w-full bg-green-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-700 transition-all shadow-md items-center justify-center gap-2">
                <i class="fa-solid fa-check"></i> Close Shape Now
            </button>
        </div>

        <div id="statusPanel" class="px-6 py-3 bg-blue-50 text-blue-800 text-xs font-medium border-b border-blue-100">
            <i class="fa-solid fa-circle-info mr-1"></i> 
            <span id="statusText">Click "Start Drawing" to begin.</span>
        </div>

        <div class="flex-1 overflow-hidden flex flex-col relative">
            <div class="p-4 bg-gray-50 border-b border-gray-200 text-xs font-semibold text-gray-500 uppercase tracking-wider flex justify-between items-center">
                <span>Streets Found</span>
                <span id="countBadge" class="bg-blue-600 text-white py-0.5 px-2 rounded-full text-[10px] hidden">0</span>
            </div>
            
            <div id="resultsList" class="flex-1 overflow-y-auto scroller p-2 space-y-1">
                <div class="h-full flex flex-col items-center justify-center text-gray-400 p-6 text-center">
                    <i class="fa-solid fa-map text-4xl mb-3 opacity-30"></i>
                    <p class="text-sm">No area selected.</p>
                </div>
            </div>

            <div id="loader" class="absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center hidden">
                <i class="fa-solid fa-circle-notch fa-spin text-blue-600 text-2xl mb-2"></i>
                <p class="text-sm font-medium text-gray-600">Identifying Streets...</p>
            </div>
        </div>
        
        <div class="p-2 text-center text-[10px] text-gray-400 border-t border-gray-100 bg-white">
            Uses OpenStreetMap & Overpass API
        </div>
    </div>

    <div id="map" class="flex-1 bg-gray-200 relative"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        const CONFIG = {
            defaultLat: 14.420850,
            defaultLng: 121.018709,
            defaultZoom: 17, // Increased zoom level for higher street accuracy
            tileUrl: 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',
            attribution: '&copy; OpenStreetMap'
        };

        const state = {
            isDrawing: false,
            points: [],
            markers: [],
            tempLine: null,
            rubberBand: null,
            polygon: null
        };

        const els = {
            map: document.getElementById('map'),
            drawBtn: document.getElementById('drawBtn'),
            finishBtn: document.getElementById('finishBtn'),
            resetBtn: document.getElementById('resetBtn'),
            statusText: document.getElementById('statusText'),
            resultsList: document.getElementById('resultsList'),
            loader: document.getElementById('loader'),
            countBadge: document.getElementById('countBadge')
        };

        const map = L.map('map', { doubleClickZoom: false }).setView([CONFIG.defaultLat, CONFIG.defaultLng], CONFIG.defaultZoom);
        L.tileLayer(CONFIG.tileUrl, { attribution: CONFIG.attribution, maxZoom: 20 }).addTo(map);

        function toggleDrawingMode() {
            if (state.polygon) clearMap();
            state.isDrawing = !state.isDrawing;
            
            if (state.isDrawing) {
                els.map.classList.add('drawing-cursor');
                els.drawBtn.classList.add('bg-red-50', 'text-red-600', 'border-red-200');
                els.drawBtn.innerHTML = '<i class="fa-solid fa-xmark"></i> <span>Cancel</span>';
                updateStatus("Click map to start. Click the <b>red pulsing dot</b> to finish the area.");
                disableMapInteractions();
            } else {
                stopDrawing();
            }
        }

        function stopDrawing() {
            state.isDrawing = false;
            els.map.classList.remove('drawing-cursor');
            els.finishBtn.classList.replace('flex', 'hidden');
            els.drawBtn.classList.remove('bg-red-50', 'text-red-600', 'border-red-200');
            els.drawBtn.innerHTML = '<i class="fa-solid fa-pen-nib"></i> <span>Start Drawing</span>';
            if (window.rubberBand) map.removeLayer(window.rubberBand);
            enableMapInteractions();
        }

        function addPoint(e) {
            if (!state.isDrawing) return;

            const latlng = e.latlng;
            state.points.push(latlng);

            const isFirst = state.points.length === 1;
            
            // Create a custom icon. First dot is special (larger/pulsing).
            const icon = L.divIcon({
                className: isFirst ? 'pulse-icon' : 'bg-white border-2 border-blue-600 rounded-full',
                iconSize: isFirst ? [20, 20] : [10, 10],
                iconAnchor: isFirst ? [10, 10] : [5, 5]
            });

            const marker = L.marker(latlng, { 
                icon: icon, 
                zIndexOffset: 2000 // Ensure start dot is always on top for easy clicking
            }).addTo(map);
            
            // CRITICAL: If they click the first dot, we close the polygon
            if (isFirst) {
                marker.on('click', (ev) => {
                    L.DomEvent.stopPropagation(ev); // Prevent adding a point on top of the first point
                    if (state.points.length >= 3) {
                        closePolygon();
                    } else {
                        updateStatus("Add at least 3 points before closing!");
                    }
                });
            }

            state.markers.push(marker);
            updateDrawingLines();

            if (state.points.length >= 3) {
                els.finishBtn.classList.replace('hidden', 'flex');
            }
        }

        function updateDrawingLines() {
            if (state.tempLine) map.removeLayer(state.tempLine);
            if (state.points.length > 1) {
                state.tempLine = L.polyline(state.points, {
                    color: '#2563eb',
                    weight: 4,
                    interactive: false
                }).addTo(map);
            }
        }

        function closePolygon() {
            if (state.points.length < 3) return;

            // Create final closed shape
            state.polygon = L.polygon(state.points, {
                color: '#1d4ed8',
                fillColor: '#3b82f6',
                fillOpacity: 0.3,
                weight: 4
            }).addTo(map);

            // Cleanup drawing UI
            state.markers.forEach(m => map.removeLayer(m));
            if (state.tempLine) map.removeLayer(state.tempLine);
            if (window.rubberBand) map.removeLayer(window.rubberBand);
            
            const finalPoints = [...state.points];
            state.markers = [];
            state.tempLine = null;
            
            stopDrawing();
            fetchStreets(finalPoints);
        }

        function clearMap() {
            state.points = [];
            state.markers.forEach(m => map.removeLayer(m));
            if (state.tempLine) map.removeLayer(state.tempLine);
            if (state.polygon) map.removeLayer(state.polygon);
            if (window.rubberBand) map.removeLayer(window.rubberBand);
            
            state.markers = [];
            state.tempLine = null;
            state.polygon = null;
            
            els.resultsList.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-gray-400 p-6 text-center"><i class="fa-solid fa-map text-4xl mb-3 opacity-30"></i><p class="text-sm">No area selected.</p></div>`;
            els.countBadge.classList.add('hidden');
            els.finishBtn.classList.replace('flex', 'hidden');
            updateStatus("Cleared. Click 'Start Drawing' to begin again.");
        }

        async function fetchStreets(points) {
            showLoading(true);
            updateStatus("Scanning detailed street data...");

            // Use fixed precision (6 decimals) to ensure API consistency and accuracy
            // and strictly format the polygon string for Overpass.
            const coords = points.map(p => `${p.lat.toFixed(6)} ${p.lng.toFixed(6)}`).join(' ');
            const startNode = points[0];
            // Ensure the polygon is explicitly closed by repeating the start node
            const polyString = `${coords} ${startNode.lat.toFixed(6)} ${startNode.lng.toFixed(6)}`;

            const query = `[out:json][timeout:60];(way["highway"]["name"](poly:"${polyString}"););out tags;`;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', { method: 'POST', body: query });
                const data = await response.json();
                const names = new Set();
                data.elements.forEach(el => el.tags?.name && names.add(el.tags.name));
                const sorted = Array.from(names).sort();
                renderList(sorted);
                updateStatus(sorted.length > 0 ? `Detected ${sorted.length} streets.` : "No street data found in this shape.");
            } catch (e) {
                updateStatus("Network error while scanning.");
            } finally {
                showLoading(false);
            }
        }

        function renderList(streets) {
            els.countBadge.textContent = streets.length;
            els.countBadge.classList.remove('hidden');
            els.resultsList.innerHTML = streets.length ? streets.map(s => `
                <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex items-center mb-1">
                    <div class="w-7 h-7 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mr-3 text-[10px]"><i class="fa-solid fa-road"></i></div>
                    <span class="text-sm text-gray-700 font-medium">${s}</span>
                </div>
            `).join('') : '<p class="p-6 text-center text-gray-400 text-sm">No streets found inside area.</p>';
        }

        function updateStatus(msg) { els.statusText.innerHTML = msg; }
        function showLoading(show) { els.loader.classList.toggle('hidden', !show); }
        function disableMapInteractions() { map.dragging.disable(); map.scrollWheelZoom.disable(); }
        function enableMapInteractions() { map.dragging.enable(); map.scrollWheelZoom.enable(); }

        els.drawBtn.addEventListener('click', toggleDrawingMode);
        els.resetBtn.addEventListener('click', clearMap);
        els.finishBtn.addEventListener('click', closePolygon);

        map.on('click', (e) => { if (state.isDrawing) addPoint(e); });

        map.on('mousemove', (e) => {
            if (state.isDrawing && state.points.length > 0) {
                if (window.rubberBand) map.removeLayer(window.rubberBand);
                window.rubberBand = L.polyline([state.points[state.points.length - 1], e.latlng], {
                    color: '#2563eb', weight: 2, dashArray: '5, 5', opacity: 0.5, interactive: false
                }).addTo(map);
            }
        });
    </script>
</body>
</html>